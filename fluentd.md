# Fluentd

[Fluentd](https://www.fluentd.org/) is an open source data collector for unified logging layer.
Fluentd allows you to unify data collection and consumption for a better use and understanding of data.

It's written in СRuby.

## Advantages:

- It consumes few resources
- Unified logging: Collects from various sources and normalizes them into a standard format.
- Flexibility and Extensibility: Plugin-based architecture and customizability.
- Scalability and Reliability: Handles high volumes of data with buffering and retry mechanisms.
- Data routing and delivery: Supports multiple output destinations and dynamic routing.
- Open source and community-driven: Free to use and with a large and active community.

## Config

File `/etc/td-agent/td-agent.conf` or `/etc/fluent/fluentd.conf`. It has blocks:

- `source` — info about data source. We can have many `source` blocks in a config file;
- `match` — has info about where to pass received data;
- `include` — info about file types;
- `system` — has system settings.

Plugins are used to connect to desired data source. Standard Plugins: `http` (for receiving HTTP-messages), `forward` (for receiving TCP-packets).

### Source section

```
# Receive events from port 24224 /tcp
<source>
  type forward
  port 24224 
</source>

# http://this.host:9880/myapp.access?json={"event":"data"}
<source>
  type http
  port 9880
</source>
```

Every event from the data source has attributes: 

- `tag` - helps to understand where to route messages
- `time` - define here time
- `record` - data in JSON format

Message example:

```
# Generated by http://this.host:9880/myapp.access?json={"event":"data"}
tag: myapp.access
time: (current time)
record: {"event":"data"}
```

### Match section

Describe features to select desired events. Standard output plugins: `file` and `forward`.

```
# Get events from port 24224
<source>
  type forward
  port 24224
</source>

# http://this.host:9880/myapp.access?json={"event":"data"}
<source>
  type http
  port 9880
</source>

# Take events with a tag "myapp.access" 
# and save them to a file /var/log/fluent/access.%Y-%m-%d
<match myapp.access>
  type file
  path /var/log/fluent/access
</match>
```
It means that all events marked with tags `myapp` and `access` we need to save to `/var/log/fluent/access`.
Events with any additional tag won't be sent to this file.

#### Match syntax

- `<match a.*>` - selects `a.b` tag, but not `a.b.c`
- `<match **>` - selects any tag: `a` и `a.b`, `a.b.c`
- `<match {a, b}>` - selects at least one of defined tags: `a`, `b`, but not `c`
- `<match {a, b}. c.*>`, `<match {a.*, b}.c>*` - we can mix `{}` with `*`, `**`
- `<match a b>` - selects `a` and `b` at once
- `<match a.** b.*>` - selects tags `a`, `a.b` and `a.b.c` (left part) and `b.d` (right часть).

**Important**: Positon of `match` tags important in the config file. In the beginning we need to place concrete rules and after that only general rules. 

Correct example where general rules are at the bottom:

```
<match myapp.access>
  type file
  path /var/log/fluent/access
</match>

<match **>
  type blackhole_plugin
</match>
```

### Extract section

It helps to extract fields from a message.

```
<source>
  @type exec
  command echo '{"value": 2, "action": "update"}'
  run_interval 5s
  <parse>
    @type json
  </parse>
  <extract>
    tag_key action
  </extract>
</source>
```

This config will extract field `action`. Later we use this value as a tag.

### Inject section

The inject section can be under `<match>` or `<filter>` section. 
It is enabled for the plugins that support injecting values to the event record.

```
<match **>
  @type stdout

  <inject>
    hostname_key "hostname"
    hostname "#{Socket.gethostname}"
    tag_key tag
  </inject>
</match>
```

As a result, a message will be sent to `stdout`, the body of which will contain a `tag` field with the value of the message tag assigned by fluentd, 
as well as a `hostname` field with the value of the host name of the node on which the fluentd process is running.

## Plugins

### Parser

See https://docs.fluentd.org/parser

#### apache2

```
<source>
  @type tail
  # ...
  <parse>
    @type apache2
  </parse>
</source>
```

#### json

The json parser plugin parses JSON logs. One JSON map per line.

```
<source>
  @type tail
  path /var/log/app.json.log
  tag myapp

  <parse>
    @type json
  </parse>
</source>
```

#### regexp

```
<source>
  @type tail
  path /var/log/app.log
  tag myapp

  <parse>
    @type regexp
    expression /^\[(?<logtime>[^\]]*)\] (?<name>[^ ]*) (?<title>[^ ]*) (?<id>\d*)$/
    time_key logtime
    time_format %Y-%m-%d %H:%M:%S %z
    types id:integer
  </parse>
</source>
```
This incoming event:

```
[2013-02-28 12:00:00 +0900] alice engineer 1
```

is parsed as:

```
time:
1362020400 (2013-02-28 12:00:00 +0900)

record:
{
  "name" : "alice",
  "title": "engineer",
  "id"   : 1
}
```

### Output plugins

See https://docs.fluentd.org/output

#### out_rewrite_tag_filter

When a message is handled by the plugin, the rules are tested one by one in order. 
If a matching rule is found, the message tag will be rewritten according to the definition in the rule and the message will be emitted again with the new tag.

```
<match apache.access>
  @type rewrite_tag_filter

  <rule>
    key code
    pattern /([45][0-9]{2})/
    tag apache.$1
  </rule>
</match>
```

This filter processes messages with the tag `apache.access`. It takes field `code` from 400 to 599 and update a tag to `apache.CODE_VALUE`.

Later we can process these messages:

```
<match {apache.4**,apache.5**}>
  @type stdout
</match>
```

## Config examples

File `/etc/fluent/fluentd.conf`.

### From file to syslog

```
<source>
  @type tail
  path /var/log/app.log
  pos_file /var/log/app.log.pos
  tag fluentd
  format apache2
</source>

## Match tag 'fluentd' logs and forward to local syslog
<match fluentd>
  @type remote_syslog
  host 127.0.0.1
  port 514
  protocol udp
</match>
```
